# Mahjong Bot - QQ éº»å°†æ¯”èµ› Elo è¯„åˆ†ç³»ç»Ÿæœºå™¨äºº

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº [Shiro](https://github.com/MisakaTAT/Shiro) æ¡†æ¶å¼€å‘çš„ QQ æœºå™¨äººæ’ä»¶ï¼Œä¸“ä¸ºéº»å°†ç±»æ¯”èµ›æä¾›è‡ªåŠ¨åŒ–è®°åˆ†ã€Elo è¯„åˆ†è®¡ç®—ä¸æ’åæ›´æ–°åŠŸèƒ½ã€‚é€‚ç”¨äºå¤šäººéº»å°†å¯¹æˆ˜ç¾¤ç»„ï¼Œæ”¯æŒè‡ªåŠ¨ç»“ç®—æ¯”èµ›ç»“æœã€æ›´æ–° Elo æ’åï¼Œå¹¶åœ¨ç¾¤å†…å‘é€ç»“æ„åŒ–æ¯”èµ›ä¿¡æ¯ã€‚

---

## ğŸ“Œ åŠŸèƒ½æ¦‚è§ˆ

### âœ… æ ¸å¿ƒåŠŸèƒ½
- **æ¯”èµ›åˆ›å»º**ï¼šæ”¯æŒé€šè¿‡æŒ‡ä»¤ `åˆ›å»ºæ¯”èµ›` åˆ›å»ºä¸€åœºæ–°çš„éº»å°†æ¯”èµ›ã€‚
- **æ¯”èµ›è®°å½•æ·»åŠ **ï¼šé€šè¿‡ `æ·»åŠ è®°å½• <æ¯”èµ›ID> <æ–¹å‘> <åˆ†æ•°>` æ·»åŠ æ¯ä½ç©å®¶çš„æ¯”èµ›å¾—åˆ†ã€‚
- **è‡ªåŠ¨ç»“ç®—**ï¼šå½“æ‰€æœ‰ç©å®¶æäº¤å®Œåˆ†æ•°åï¼Œè‡ªåŠ¨è¿›è¡Œç²¾ç®—å¹¶ç»“æŸæ¯”èµ›ã€‚
- **Elo è¯„åˆ†æ›´æ–°**ï¼šæ ¹æ®æ¯”èµ›ç»“æœä½¿ç”¨ Elo ç®—æ³•åŠ¨æ€è°ƒæ•´ç©å®¶è¯„åˆ†ã€‚
- **æ¶ˆæ¯æ¨é€**ï¼šæ¯”èµ›ç»“æŸåè‡ªåŠ¨å‘ç¾¤ç»„å‘é€ç»“æ„åŒ–æ¯”èµ›ç»“æœä¸ Elo å˜åŠ¨æƒ…å†µã€‚
- **æ•°æ®æŒä¹…åŒ–**ï¼šä½¿ç”¨ MyBatis + MySQL å­˜å‚¨æ¯”èµ›è®°å½•ã€Elo å†å²ç­‰ä¿¡æ¯ã€‚

---

## ğŸ§© æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | æè¿° |
|------|------|
| Java 17+ | ä¸»è¯­è¨€ |
| Spring Boot | åç«¯æ¡†æ¶ |
| Shiro | QQ æœºå™¨äººæ¡†æ¶ |
| MyBatis Plus | ORM æ•°æ®åº“æ“ä½œ |
| MySQL | æ•°æ®å­˜å‚¨ |
| Lombok | è‡ªåŠ¨ç”Ÿæˆ Getter/Setter |
| Markdown/MsgUtils | æ¶ˆæ¯æ ¼å¼åŒ–è¾“å‡º |

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
mahjong-bot/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/
â”‚   â”‚   â”œâ”€â”€ java/org/liahnu/bot/
â”‚   â”‚   â”‚   â”œâ”€â”€ config/         # é…ç½®ç±»ï¼ˆå¦‚ BotConfigï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ model/          # æ•°æ®æ¨¡å‹ï¼ˆContest, ContestRecord, Eloï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ plugin/         # Shiro æ’ä»¶ç±»ï¼ˆå¤„ç†ç¾¤èŠæŒ‡ä»¤ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ service/        # ä¸šåŠ¡é€»è¾‘æ¥å£åŠå®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ util/           # å·¥å…·ç±»ï¼ˆElo è®¡ç®—ã€ç‚¹æ•°è§„åˆ™ç­‰ï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ Main.java       # Spring Boot å¯åŠ¨ç±»
â”‚   â”‚   â””â”€â”€ resources/
â”‚   â”‚       â”œâ”€â”€ application.yaml # é…ç½®æ–‡ä»¶ï¼ˆæ•°æ®åº“ã€æœºå™¨äººè´¦å·ç­‰ï¼‰
â”‚   â”‚       â””â”€â”€ mapper/         # MyBatis XML æ˜ å°„æ–‡ä»¶
â”‚   â””â”€â”€ test/                   # å•å…ƒæµ‹è¯•
â”œâ”€â”€ build.gradle.kts             # æ„å»ºé…ç½®
â”œâ”€â”€ gradlew / gradlew.bat        # Gradle Wrapper
â””â”€â”€ README.md                    # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```


---

## ğŸ› ï¸ åŠŸèƒ½æ¨¡å—ä»‹ç»

### 1. æ¯”èµ›ç®¡ç†æ¨¡å— (`ContestPlugin`)
- åˆ›å»ºæ¯”èµ› `åˆ›å»ºæ¯”èµ›`
- æŸ¥è¯¢æ¯”èµ› `æŸ¥è¯¢æ¯”èµ›`
- æ”¯æŒ RCRã€MLeague ç­‰å¤šç§éº»å°†è§„åˆ™

### 2. æ¯”èµ›è®°å½•æ¨¡å— (`ContestRecordPlugin`)
- æ·»åŠ æ¯”èµ›è®°å½• `æ·»åŠ è®°å½• <æ¯”èµ›ID> <æ–¹å‘> <åˆ†æ•°>`
- è‡ªåŠ¨è§¦å‘ Elo æ›´æ–°ä¸æ¯”èµ›çŠ¶æ€å˜æ›´

### 3. Elo è¯„åˆ†æ¨¡å— (`elo`)
- ä½¿ç”¨ Elo ç®—æ³•åŠ¨æ€æ›´æ–°ç©å®¶è¯„åˆ†
- æ”¯æŒä¸åŒéº»å°†ç±»å‹ç‹¬ç«‹è¯„åˆ†ï¼ˆå¦‚ RCRã€MLeagueï¼‰

### 4. ç‚¹æ•°è®¡ç®—æ¨¡å— ([point](file://C:\Users\li hanyu\IdeaProjects\mahjong-bot\src\main\java\org\liahnu\bot\model\domain\ContestRecord.java#L44-L45))
- æ”¯æŒå¤šç§éº»å°†è§„åˆ™ï¼ˆRCRã€MLeague ç­‰ï¼‰çš„ç‚¹æ•°ç»“ç®—
- æä¾› [RuleCalculate.calculate(...)](file://C:\Users\li hanyu\IdeaProjects\mahjong-bot\src\main\java\org\liahnu\bot\util\point\RuleCalculate.java#L18-L18) æ–¹æ³•è¿›è¡Œç‚¹æ•°è½¬æ¢

---

## ğŸ§ª ç¤ºä¾‹æµç¨‹

### åˆ›å»ºæ¯”èµ›ï¼š
```text
@bot åˆ›å»ºæ¯”èµ›
```


### æ·»åŠ è®°å½•ï¼š
```text
@bot æ·»åŠ è®°å½• 1001 ä¸œ 50
@bot æ·»åŠ è®°å½• 1001 å— 10
@bot æ·»åŠ è®°å½• 1001 è¥¿ -10
@bot æ·»åŠ è®°å½• 1001 åŒ— -40
```

## éƒ¨ç½²é¡¹ç›®

### Docker

```shell
docker pull registry.cn-beijing.aliyuncs.com/1328411791/mahjong-bot:latest
docker run -d -p 8080:8080 \
  -e bots.bot-id=your_bot_id \
  -e bots.ws-url=your_ws_url \
  -e mysql.url=your_mysql_url \
  -e mysql.username=your_username \
  -e mysql.password=your_password \
  registry.cn-beijing.aliyuncs.com/1328411791/mahjong-bot:latest
```
æˆ–è€…ä½¿ç”¨ docker-compose

```yaml
version: '3'
services:
  mahjong-bot:
    image: registry.cn-beijing.aliyuncs.com/1328411791/mahjong-bot:latest
    ports:
      - "8080:8080"
    environment:
      - bots.bot-id=your_bot_id
      - bots.ws-url=your_ws_url
      - mysql.url=your_mysql_url
      - mysql.username=your_username
      - mysql.password=your_password
    networks:
      - mahjong-bot
    restart: always
```

åœ¨éƒ¨ç½²æ–¹é¢éœ€è¦OneBotåè®®çš„æœºå™¨äººè¿è¡Œ,æ¨èä½¿ç”¨[Lagrange.OneBot](https://lagrangedev.github.io/Lagrange.Doc/v1/Lagrange.OneBot/)
,å…·ä½“éƒ¨ç½²æ–¹é¢å‚è€ƒå¯¹åº”æ–‡æ¡£


### æ¯”èµ›ç»“æŸï¼š
å½“æ‰€æœ‰ç©å®¶æäº¤å®Œæ¯•ï¼Œç³»ç»Ÿè‡ªåŠ¨ç»“ç®—å¹¶æ¨é€å¦‚ä¸‹æ¶ˆæ¯ï¼š

```
ğŸ† æ¯”èµ›ç»“æŸï¼ä»¥ä¸‹æ˜¯ Elo å˜åŠ¨æƒ…å†µï¼š
------------------------------
ğŸ‘¤ ç”¨æˆ· ID: 123456789
ğŸ“ˆ Elo: 2000 â†’ 2015 (+15)
------------------------------
ğŸ‘¤ ç”¨æˆ· ID: 987654321
ğŸ“ˆ Elo: 2100 â†’ 2085 (-15)
------------------------------
```


---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

ç¡®ä¿ä½ å·²å®‰è£…ä»¥ä¸‹ç¯å¢ƒï¼š

- Java 17+
- Maven æˆ– Gradle
- MySQL 5.7+

### 2. åˆå§‹åŒ–æ•°æ®åº“

å¯¼å…¥ SQL è¡¨ç»“æ„,è§ /doc/table.sql


### 3. ä¿®æ”¹é…ç½®æ–‡ä»¶

ç¼–è¾‘ `application.yaml`ï¼š

```yaml
shiro:
  bots:
    - qq: 3542130180
      enable: true

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/mahjong_bot?useSSL=false&serverTimezone=UTC
    username: root
    password: your_password
    driver-class-name: com.mysql.cj.jdbc.Driver
```


### 4. ç¼–è¯‘è¿è¡Œ

```bash
./gradlew bootRun
```


---

## ğŸ“¬ å‘½ä»¤åˆ—è¡¨

| å‘½ä»¤ | å‚æ•°                 | è¯´æ˜                     |
|------|--------------------|------------------------|
| åˆ›å»ºæ¯”èµ› | æ—                   | åˆ›å»ºä¸€åœºæ–°æ¯”èµ›ï¼ˆé»˜è®¤ RCR è§„åˆ™ï¼‰     |
| æŸ¥è¯¢æ¯”èµ› | æ—                   | æŸ¥çœ‹å½“å‰ç¾¤ç»„æœ€è¿‘çš„æ¯”èµ›ä¿¡æ¯          |
| æ·»åŠ è®°å½• | `<æ¯”èµ›ID> <åº§ä½> <åˆ†æ•°>` | æ·»åŠ å•å±€æ¯”èµ›æˆç»©ï¼Œè‡ªåŠ¨è§¦å‘ Elo æ›´æ–°   |
| æŸ¥çœ‹æ’å | æ—                   | æŸ¥çœ‹å½“å‰ Elo æ’åæ¦œï¼ˆéœ€è‡ªè¡Œå®ç°ï¼‰    |
| æ›´æ–°æ¯”èµ› | `<æ¯”èµ›ID>`           | æ‰‹åŠ¨è§¦å‘ Elo ç»“ç®—ï¼ˆä»…é™ç§èŠï¼‰ ç”¨äºæµ‹è¯• |

---

## ğŸ“Š Elo ç³»ç»Ÿè¯´æ˜

### Elo å…¬å¼å‚è€ƒï¼š

```java
expectedScore = 1 / (1 + Math.pow(10, (opponentRating - playerRating) / 400));
newRating = currentRating + kFactor * (actualScore - expectedScore);
```


### K å› å­è®¡ç®—æ–¹å¼ï¼š

```java
kFactor = 16 * (1 + Math.abs(ratingDifference) / 400);
```


---

## ğŸ§ª æµ‹è¯•å»ºè®®

- å•å…ƒæµ‹è¯•ä½¿ç”¨ JUnit 5ï¼Œè¦†ç›– Elo è®¡ç®—ã€ç‚¹æ•°è½¬æ¢ã€æ¯”èµ›çŠ¶æ€æµè½¬ç­‰æ ¸å¿ƒé€»è¾‘ã€‚
- å¯ä½¿ç”¨ H2 å†…å­˜æ•°æ®åº“è¿›è¡Œé›†æˆæµ‹è¯•ã€‚
- å»ºè®®ç¼–å†™æ¨¡æ‹Ÿ Bot å‘é€æ¶ˆæ¯çš„æµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯æ¶ˆæ¯æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚

---

## ğŸ¤ å¼€å‘è´¡çŒ®

æ¬¢è¿ Fork & PRï¼

ä½ å¯ä»¥å‚ä¸çš„æ–¹å‘åŒ…æ‹¬ï¼š

- æ”¯æŒæ›´å¤šéº»å°†è§„åˆ™ï¼ˆå¦‚å›½æ ‡ã€ç«‹ç›´A,Rç­‰è§„åˆ™ã€å¹¿ä¸œéº»å°†ç­‰ï¼‰
- å®ç° Elo çš„ Glicko-2 æ›¿ä»£ç®—æ³•
- æ·»åŠ ç”¨æˆ·æ˜µç§°ç»‘å®šã€æ’è¡Œæ¦œå±•ç¤ºã€å†å²æˆ˜ç»©æŸ¥è¯¢ç­‰åŠŸèƒ½
- æ”¯æŒ Markdown æ ¼å¼æ¶ˆæ¯è¾“å‡º

---

## ğŸ“œ License

MIT License

---